---
# CIS Red Hat Enterprise Linux 10 Benchmark v1.0.1
# Section 5.3: Pluggable Authentication Modules
# Ansible Playbook for PAM Hardening

# Purpose:
#   This playbook hardens the authentication (PAM) configuration on RHEL 10 
#   systems according to the CIS RHEL 10 Benchmark v1.0.1. It enforces 
#   secure settings, including:
#     - Implementing account lockout policies (pam_faillock)
#     - Enforcing password complexity requirements (pam_pwquality)
#     - Enforcing password history to prevent reuse (pam_pwhistory)
#     - Configuring strong password hashing algorithms (pam_unix)
#     - Deploying custom authselect profiles for system authentication
#
# Scope:
#   - Applies to all hosts targeted in the inventory
#   - Requires root privileges (become: yes)
#   - Implements both CIS benchmark defaults and custom security policies
#   - WARNING: These changes affect authentication - test thoroughly first!
#
# Usage:
#   ansible-playbook -i inventory_file pam_hardening.yml
#   
#   Run specific subsections:
#   ansible-playbook -i inventory_file pam_hardening.yml --tags section5.3.1
#   ansible-playbook -i inventory_file pam_hardening.yml --tags section5.3.2

- name: CIS RHEL 10 - PAM Hardening
  hosts: all
  become: yes
  vars:
    # =========================================================================
    # Section 5.3: PAM Configuration Variables
    # =========================================================================
    
    # Account Lockout Policy (pam_faillock)
    faillock_deny: 5                         # Failed login attempts before lockout
    faillock_unlock_time: 900                # Auto-unlock time in seconds (15 minutes)
    
    # Password Quality Requirements (pam_pwquality)
    pwquality_minlen: 14                     # Minimum password length
    pwquality_minclass: 4                    # Minimum character classes (digit/upper/lower/special)
    pwquality_dcredit: -1                    # Minimum digits required
    pwquality_ucredit: -1                    # Minimum uppercase characters
    pwquality_lcredit: -1                    # Minimum lowercase characters
    pwquality_ocredit: -1                    # Minimum special characters
    pwquality_maxrepeat: 3                   # Maximum consecutive identical characters
    pwquality_maxsequence: 3                 # Maximum sequential characters (abc, 123, etc.)
    
    # Password History Policy (pam_pwhistory)
    pwhistory_remember: 5                    # Number of old passwords to remember
    
    # Authselect Profile Configuration
    custom_profile_name: "custom-hardened"   # Custom authselect profile name
    base_profile: "sssd"                     # Base profile: sssd, local, or winbind

  tasks:
    # =========================================================================
    # Section 5.3: Pluggable Authentication Modules
    # =========================================================================

    # Install required PAM packages
    - name: 5.3 - Install authselect and PAM packages
      package:
        name:
          - authselect
          - libpwquality
        state: present
      tags:
        - level1
        - automated
        - section5.3

    # =========================================================================
    # Section 5.3.1: Configure authselect
    # =========================================================================

    # 5.3.1.1 Ensure active authselect profile includes pam modules (Automated)
    - name: 5.3.1.1 - Check if custom authselect profile exists
      stat:
        path: "/etc/authselect/custom/{{ custom_profile_name }}"
      register: custom_profile
      tags:
        - level1
        - automated
        - section5.3.1.1

    - name: 5.3.1.1 - Create custom authselect profile
      command:
        cmd: "authselect create-profile {{ custom_profile_name }} -b {{ base_profile }}"
      when: not custom_profile.stat.exists
      tags:
        - level1
        - automated
        - section5.3.1.1
    
    - name: 5.3.1.1 - Get current authselect profile
      command: authselect current
      register: authselect_current
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.1.1

    - name: 5.3.1.1 - Select custom authselect profile with required features
      command:
        cmd: >
          authselect select custom/{{ custom_profile_name }}
          with-faillock
          with-pwhistory
          without-nullok
          --force
      when: "'custom/' ~ custom_profile_name not in authselect_current.stdout"
      tags:
        - level1
        - automated
        - section5.3.1.1

    # 5.3.1.2 Ensure pam_faillock module is enabled (Automated)
    - name: 5.3.1.2 - Verify pam_faillock is configured in authselect profile
      shell: |
        grep -P -- '\bpam_faillock\.so\b' /etc/pam.d/{password,system}-auth
      register: faillock_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.1.2

    - name: 5.3.1.2 - Display pam_faillock verification
      debug:
        msg: "pam_faillock is enabled in PAM configuration"
      when: faillock_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.1.2

    # 5.3.1.3 Ensure pam_pwquality module is enabled (Automated)
    - name: 5.3.1.3 - Verify pam_pwquality is configured in authselect profile
      shell: |
        grep -P -- '\bpam_pwquality\.so\b' /etc/pam.d/{password,system}-auth
      register: pwquality_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.1.3

    - name: 5.3.1.3 - Display pam_pwquality verification
      debug:
        msg: "pam_pwquality is enabled in PAM configuration"
      when: pwquality_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.1.3

    # 5.3.1.4 Ensure pam_pwhistory module is enabled (Automated)
    - name: 5.3.1.4 - Verify pam_pwhistory is configured in authselect profile
      shell: |
        grep -P -- '\bpam_pwhistory\.so\b' /etc/pam.d/{password,system}-auth
      register: pwhistory_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.1.4

    - name: 5.3.1.4 - Display pam_pwhistory verification
      debug:
        msg: "pam_pwhistory is enabled in PAM configuration"
      when: pwhistory_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.1.4

    # 5.3.1.5 Ensure pam_unix module is enabled (Automated)
    - name: 5.3.1.5 - Verify pam_unix is configured in authselect profile
      shell: |
        grep -P -- '\bpam_unix\.so\b' /etc/pam.d/{password,system}-auth
      register: unix_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.1.5

    - name: 5.3.1.5 - Display pam_unix verification
      debug:
        msg: "pam_unix is enabled in PAM configuration"
      when: unix_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.1.5

    # =========================================================================
    # Section 5.3.2: Configure PAM Arguments
    # =========================================================================

    # 5.3.2.1.1 Ensure password failed attempts lockout is configured (Automated)
    - name: 5.3.2.1.1 - Configure faillock deny attempts
      lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^#?\s*deny\s*='
        line: "deny = {{ faillock_deny }}"
      tags:
        - level1
        - automated
        - section5.3.2.1.1

    # 5.3.2.1.2 Ensure password unlock time is configured (Automated)
    - name: 5.3.2.1.2 - Configure faillock unlock time
      lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^#?\s*unlock_time\s*='
        line: "unlock_time = {{ faillock_unlock_time }}"
      tags:
        - level1
        - automated
        - section5.3.2.1.2

    # 5.3.2.1.3 Ensure password failed attempts lockout includes root account (Automated)
    - name: 5.3.2.1.3 - Configure faillock to include root account
      lineinfile:
        path: /etc/security/faillock.conf
        regexp: '^#?\s*even_deny_root'
        line: "even_deny_root"
      tags:
        - level1
        - automated
        - section5.3.2.1.3

    # 5.3.2.2.1 Ensure password number of changed characters is configured (Automated)
    - name: 5.3.2.2.1 - Configure password changed characters requirement
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*difok\s*='
        line: "difok = 2"
      tags:
        - level1
        - automated
        - section5.3.2.2.1

    # 5.3.2.2.2 Ensure password length is configured (Automated)
    - name: 5.3.2.2.2 - Configure password minimum length
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*minlen\s*='
        line: "minlen = {{ pwquality_minlen }}"
      tags:
        - level1
        - automated
        - section5.3.2.2.2

    # 5.3.2.2.3 Ensure password complexity is configured (Manual)
    - name: 5.3.2.2.3 - Configure password complexity - minclass
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*minclass\s*='
        line: "minclass = {{ pwquality_minclass }}"
      tags:
        - level1
        - manual
        - section5.3.2.2.3

    - name: 5.3.2.2.3 - Configure password complexity - dcredit
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*dcredit\s*='
        line: "dcredit = {{ pwquality_dcredit }}"
      tags:
        - level1
        - manual
        - section5.3.2.2.3

    - name: 5.3.2.2.3 - Configure password complexity - ucredit
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*ucredit\s*='
        line: "ucredit = {{ pwquality_ucredit }}"
      tags:
        - level1
        - manual
        - section5.3.2.2.3

    - name: 5.3.2.2.3 - Configure password complexity - lcredit
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*lcredit\s*='
        line: "lcredit = {{ pwquality_lcredit }}"
      tags:
        - level1
        - manual
        - section5.3.2.2.3

    - name: 5.3.2.2.3 - Configure password complexity - ocredit
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*ocredit\s*='
        line: "ocredit = {{ pwquality_ocredit }}"
      tags:
        - level1
        - manual
        - section5.3.2.2.3

    # 5.3.2.2.4 Ensure password same consecutive characters is configured (Automated)
    - name: 5.3.2.2.4 - Configure password maximum consecutive characters
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*maxrepeat\s*='
        line: "maxrepeat = {{ pwquality_maxrepeat }}"
      tags:
        - level1
        - automated
        - section5.3.2.2.4

    # 5.3.2.2.5 Ensure password maximum sequential characters is configured (Automated)
    - name: 5.3.2.2.5 - Configure password maximum sequential characters
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*maxsequence\s*='
        line: "maxsequence = {{ pwquality_maxsequence }}"
      tags:
        - level1
        - automated
        - section5.3.2.2.5

    # 5.3.2.2.6 Ensure password dictionary check is enabled (Automated)
    - name: 5.3.2.2.6 - Ensure password dictionary check is not disabled
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*dictcheck\s*=\s*0'
        state: absent
      tags:
        - level1
        - automated
        - section5.3.2.2.6

    # 5.3.2.2.7 Ensure password quality is enforced for the root user (Automated)
    - name: 5.3.2.2.7 - Ensure password quality enforced for root user
      lineinfile:
        path: /etc/security/pwquality.conf
        regexp: '^#?\s*enforce_for_root'
        line: "enforce_for_root"
      tags:
        - level1
        - automated
        - section5.3.2.2.7

    # 5.3.2.3.1 Ensure password history remember is configured (Automated)
    - name: 5.3.2.3.1 - Configure password history remember
      lineinfile:
        path: /etc/security/pwhistory.conf
        regexp: '^#?\s*remember\s*='
        line: "remember = {{ pwhistory_remember }}"
        create: yes
        mode: '0644'
        owner: root
        group: root
      tags:
        - level1
        - automated
        - section5.3.2.3.1

    # 5.3.2.3.2 Ensure password history is enforced for the root user (Automated)
    - name: 5.3.2.3.2 - Ensure password history enforced for root user
      lineinfile:
        path: /etc/security/pwhistory.conf
        regexp: '^#?\s*enforce_for_root'
        line: "enforce_for_root"
        create: yes
        mode: '0644'
        owner: root
        group: root
      tags:
        - level1
        - automated
        - section5.3.2.3.2

    # 5.3.2.3.3 Ensure pam_pwhistory includes use_authtok (Automated)
    - name: 5.3.2.3.3 - Verify pam_pwhistory uses use_authtok
      shell: |
        grep -Pi '^\h*password\h+.*\bpam_pwhistory\.so\b.*\buse_authtok\b' /etc/pam.d/{password,system}-auth
      register: pwhistory_authtok_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.2.3.3

    - name: 5.3.2.3.3 - Display pam_pwhistory use_authtok verification
      debug:
        msg: "pam_pwhistory is configured with use_authtok"
      when: pwhistory_authtok_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.2.3.3

    # 5.3.2.4.1 Ensure pam_unix does not include nullok (Automated)
    - name: 5.3.2.4.1 - Verify pam_unix does not include nullok
      shell: |
        grep -Pi '^\h*password\h+.*\bpam_unix\.so\b' /etc/pam.d/{password,system}-auth | grep -v '\bnullok\b'
      register: unix_nullok_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.2.4.1

    - name: 5.3.2.4.1 - Display pam_unix nullok verification
      debug:
        msg: "pam_unix is configured without nullok (without-nullok enabled)"
      when: unix_nullok_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.2.4.1

    # 5.3.2.4.2 Ensure pam_unix does not include remember (Automated)
    - name: 5.3.2.4.2 - Verify pam_unix does not include remember
      shell: |
        grep -Pi '^\h*password\h+.*\bpam_unix\.so\b' /etc/pam.d/{password,system}-auth | grep -v '\bremember='
      register: unix_remember_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.2.4.2

    - name: 5.3.2.4.2 - Display pam_unix remember verification
      debug:
        msg: "pam_unix is configured without remember argument (using pam_pwhistory instead)"
      when: unix_remember_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.2.4.2

    # 5.3.2.4.3 Ensure pam_unix includes a strong password hashing algorithm (Automated)
    - name: 5.3.2.4.3 - Verify pam_unix uses strong hashing algorithm
      shell: |
        grep -Pi '^\h*password\h+.*\bpam_unix\.so\b.*\b(sha512|yescrypt)\b' /etc/pam.d/{password,system}-auth
      register: unix_hash_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.2.4.3

    - name: 5.3.2.4.3 - Display pam_unix hashing algorithm verification
      debug:
        msg: "pam_unix is configured with strong password hashing (sha512 or yescrypt)"
      when: unix_hash_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.2.4.3

    # 5.3.2.4.4 Ensure pam_unix includes use_authtok (Automated)
    - name: 5.3.2.4.4 - Verify pam_unix uses use_authtok
      shell: |
        grep -Pi '^\h*password\h+.*\bpam_unix\.so\b.*\buse_authtok\b' /etc/pam.d/{password,system}-auth
      register: unix_authtok_check
      changed_when: false
      failed_when: false
      tags:
        - level1
        - automated
        - section5.3.2.4.4

    - name: 5.3.2.4.4 - Display pam_unix use_authtok verification
      debug:
        msg: "pam_unix is configured with use_authtok"
      when: unix_authtok_check.rc == 0
      tags:
        - level1
        - automated
        - section5.3.2.4.4

    # =========================================================================
    # Apply authselect changes to ensure all PAM configurations are active
    # =========================================================================
    - name: Apply authselect changes
      command:
        cmd: authselect apply-changes
      tags:
        - level1
        - automated
        - section5.3

    # =========================================================================
    # Verification and Reporting
    # =========================================================================
    - name: Verify authselect profile is active
      command:
        cmd: authselect current
      register: authselect_verify
      changed_when: false
      failed_when: false
      tags:
        - verify

    - name: Display configuration summary
      debug:
        msg:
          - "=============================================="
          - "CIS RHEL 10 - PAM Configuration Summary"
          - "=============================================="
          - "Authselect profile: {{ authselect_verify.stdout }}"
          - "Account lockout: {{ faillock_deny }} attempts, {{ faillock_unlock_time }}s unlock"
          - "Password length: {{ pwquality_minlen }} characters minimum"
          - "Password history: {{ pwhistory_remember }} passwords remembered"
          - "=============================================="
      tags:
        - verify
